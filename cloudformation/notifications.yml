AWSTemplateFormatVersion: '2010-09-09'
Description: 'Frontend Notifications Infrastructure'

Parameters:
  GCMSubscriptionsTableName:
    Description: The table name of the GCM Subscriptions Table
    Type: String
  FrontendNotificationMessageTableName:
    Description: The table name of the notification messages table
    Type: String
  GCMWorkerQueueName:
    Description: The name of the GCM work queue
    Type: String
  TopicMessageQueueName:
    Description: The name of the topic message queue
    Type: String
  LastSentTableName:
    Description: The name of the last sent message database
    Type: String
  FrontendNotificationMessagesCacheClusterName:
    Description: The name of the notification messages cache cluster
    Type: String

Resources:
  GCMWorkerQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: {Ref: GCMWorkerQueueName}

  TopicMessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: {Ref: TopicMessageQueueName}

  GCMSubscriptionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: {Ref: GCMSubscriptionsTableName}
      KeySchema:
        - {AttributeName: notificationTopicId, KeyType: HASH}
        - {AttributeName: gcmBrowserId, KeyType: RANGE}
      AttributeDefinitions:
        - {AttributeName: notificationTopicId, AttributeType: S}
        - {AttributeName: gcmBrowserId, AttributeType: S}
      ProvisionedThroughput:
        ReadCapacityUnits: 10
        WriteCapacityUnits: 10

  LastSentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: {Ref: LastSentTableName}
      KeySchema:
        - {AttributeName: topicId, KeyType: HASH}
      AttributeDefinitions:
        - {AttributeName: topicId, AttributeType: S}
      ProvisionedThroughput:
        ReadCapacityUnits: 10
        WriteCapacityUnits: 10

  FrontendNotificationMessages:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: {Ref: FrontendNotificationMessageTableName}
      KeySchema:
        - {AttributeName: gcmBrowserId, KeyType: HASH}
      AttributeDefinitions:
        - {AttributeName: gcmBrowserId, AttributeType: S}
      ProvisionedThroughput:
        ReadCapacityUnits: 10
        WriteCapacityUnits: 10

  FrontendNotificationsVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.248.120.0/22
      Tags:
        - {Key: Name, Value: frontend-notifications}

  FrontendNotificationsSubnetOne:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.248.120.0/24
      VpcId: {Ref: FrontendNotificationsVPC}
      AvailabilityZone: eu-west-1a
      Tags:
        - {Key: Name, Value: frontend-notifications-eu-west-1a}

  FrontendNotificationsSubnetTwo:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.248.121.0/24
      VpcId: {Ref: FrontendNotificationsVPC}
      AvailabilityZone: eu-west-1b
      Tags:
        - {Key: Name, Value: frontend-notifications-eu-west-1b}

  FrontendNotificationsSubnetThree:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 10.248.122.0/24
      VpcId: {Ref: FrontendNotificationsVPC}
      AvailabilityZone: eu-west-1c
      Tags:
        - {Key: Name, Value: frontend-notifications-eu-west-1c}


  ElasticacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Frontend notification elasticache messages subnet group
      SubnetIds:
        - {Ref: FrontendNotificationsSubnetOne}
        - {Ref: FrontendNotificationsSubnetTwo}
        - {Ref: FrontendNotificationsSubnetThree}

  ElasticacheSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: {Ref: FrontendNotificationsVPC}
      GroupDescription: Frontend Notification Messages security group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          CidrIp: 0.0.0.0/0

  FrontendNotificationMessagesCacheCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      ClusterName: {Ref: FrontendNotificationMessagesCacheClusterName}
      CacheSubnetGroupName: {Ref: ElasticacheSubnetGroup}
      VpcSecurityGroupIds:
        - {Ref: ElasticacheSecurityGroup}
      CacheNodeType: cache.t2.small
      #1 CPU 1.5GB Memory, next up is cache.t2.medium 2CPU 3.2GB Memory
      AutoMinorVersionUpgrade: "true"
      Engine: redis
      NumCacheNodes: 1

